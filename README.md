# 1C-Sweeper

Система автоматизированного обслуживания локальных копий Git-репозиториев, EDT workspaces и информационных баз 1С.

## Описание

1C-Sweeper решает проблему систематического раздувания дискового пространства при разработке на платформе 1С:EDT с использованием Git:

- **Git-репозитории**: уменьшение размера с 25-30 ГБ до 12-15 ГБ за счет очистки garbage pack-файлов
- **EDT Workspaces**: освобождение 60-80% места путем удаления временных файлов, истории, снапшотов и кэшей
- **Базы данных 1С**: оптимизация через тестирование и исправление

### Основные возможности

✅ Автоматический поиск объектов для обслуживания  
✅ Проверка пороговых значений размера перед обработкой  
✅ Безопасная очистка с проверкой блокировок  
✅ Детальные JSON-отчеты о выполненных операциях  
✅ Интеграция с планировщиком задач Windows  
✅ Тихий режим для автоматического запуска  

## Требования

### Программное обеспечение

- **Python** 3.8 или выше
- **Git** (доступен из командной строки)
- **Платформа 1С:Предприятие** 8.3 (любая редакция)
- **1C:EDT** (если используются workspaces)
- **Windows** 10/11 или Windows Server 2016+

### Python-зависимости

- `psutil` - для работы с процессами и мониторинга
- `pytest`, `pytest-cov`, `pytest-mock` - для тестирования (dev)

Зависимости устанавливаются автоматически установщиком.

## Установка

### Быстрый старт

1. Клонируйте репозиторий:
```bash
git clone https://github.com/eraserhp/1C-Sweeper.git
cd 1C-Sweeper
```

2. Запустите установщик:
```bash
python install.py
```

Установщик выполнит:
- Проверку версии Python
- Установку зависимостей
- Интерактивный сбор конфигурации
- Создание файла `maintenance-config.json`
- Настройку планировщика задач Windows
- Тестовый запуск системы

### Ручная установка

Если предпочитаете ручную настройку:

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Создайте файл `maintenance-config.json` на основе примера ниже

3. Настройте планировщик задач вручную (опционально)

## Конфигурация

### Структура конфигурационного файла

```json
{
  "settings": {
    "git": {
      "repos": [
        "C:\\Dev\\Project1",
        "C:\\Dev\\Project2"
      ],
      "searchPaths": [
        "C:\\Dev",
        "D:\\Projects"
      ],
      "sizeThresholdGB": 15
    },
    "edt": {
      "workspaces": [
        "C:\\EDT\\workspace1"
      ],
      "searchPaths": [
        "C:\\EDT",
        "D:\\Workspaces"
      ],
      "sizeThresholdGB": 5
    },
    "database": {
      "databases": [
        "C:\\Bases\\Dev\\1Cv8.1CD"
      ],
      "searchPaths": [
        "C:\\Bases",
        "D:\\1C_Bases"
      ],
      "platformVersion": "8.3.27",
      "user": "Admin",
      "password": "QWRtaW4xMjM=",
      "sizeThresholdGB": 3
    },
    "general": {
      "reportsPath": "./reports",
      "silentMode": false,
      "parallelProcessing": false,
      "maxParallelTasks": 2
    }
  }
}
```

### Параметры конфигурации

#### Git-репозитории

- `repos` - массив явных путей к репозиториям
- `searchPaths` - массив папок для автоматического поиска (на 1 уровень вглубь)
- `sizeThresholdGB` - порог размера для запуска обслуживания (по умолчанию 15 ГБ)

#### EDT Workspaces

- `workspaces` - массив явных путей к workspace
- `searchPaths` - массив папок для поиска (по наличию `.metadata`)
- `sizeThresholdGB` - порог размера для запуска обслуживания (по умолчанию 5 ГБ)

#### Информационные базы 1С

- `databases` - массив явных путей к базам `.1CD`
- `searchPaths` - массив папок для поиска баз
- `platformVersion` - маска версии платформы ("8.3.27", "8.3.*", "8.3.2[0-9]")
- `user` - логин для доступа к базам (опционально)
- `password` - пароль в Base64 (опционально)
- `sizeThresholdGB` - порог размера для запуска обслуживания (по умолчанию 3 ГБ)

#### Общие параметры

- `reportsPath` - путь для сохранения JSON-отчетов (по умолчанию `./reports`)
- `silentMode` - тихий режим по умолчанию (true/false)
- `parallelProcessing` - параллельная обработка (в разработке, пока false)
- `maxParallelTasks` - максимальное количество параллельных задач

## Использование

### Ручной запуск

```bash
# Обычный режим (с подробным выводом)
python -m src.maintenance

# Тихий режим (только критические ошибки)
python -m src.maintenance --silent

# Указать другой конфигурационный файл
python -m src.maintenance --config my-config.json
```

### Автоматический запуск

Установщик автоматически создает задачу в планировщике Windows. Параметры по умолчанию:

- **Имя задачи**: 1C-Sweeper-Maintenance
- **Расписание**: еженедельно, суббота, 22:00
- **Режим**: тихий (silent mode)

### Управление задачей планировщика

```bash
# Просмотр задачи
schtasks /Query /TN "1C-Sweeper-Maintenance"

# Запуск задачи вручную
schtasks /Run /TN "1C-Sweeper-Maintenance"

# Удаление задачи
schtasks /Delete /TN "1C-Sweeper-Maintenance" /F

# Изменение расписания (например, на ежедневное в 23:00)
schtasks /Change /TN "1C-Sweeper-Maintenance" /SC DAILY /ST 23:00
```

## Деинсталляция

### Автоматическая деинсталляция

Для полного удаления системы 1C-Sweeper используйте деинсталлятор:

```bash
# Интерактивная деинсталляция
python uninstall.py

# Принудительное удаление без запросов
python uninstall.py --force

# Сохранить отчеты при удалении
python uninstall.py --keep-reports

# Сохранить зависимости при удалении
python uninstall.py --keep-dependencies

# Сохранить исходные файлы при удалении
python uninstall.py --keep-source

# Комбинированные опции
python uninstall.py --force --keep-reports --keep-dependencies
```

Деинсталлятор выполнит:

- ✅ Удаление задачи из планировщика Windows
- ✅ Удаление конфигурационных файлов (`maintenance-config.json`)
- ✅ Обработку директории с отчетами (с запросом подтверждения)
- ✅ Удаление Python-зависимостей (опционально)
- ✅ Удаление исходных файлов системы (опционально)

### Ручная деинсталляция

Если автоматический деинсталлятор недоступен:

```bash
# Удаление задачи планировщика
schtasks /Delete /TN "1C-Sweeper-Maintenance" /F

# Удаление конфигурации
del maintenance-config.json

# Удаление директории с отчетами (опционально)
rmdir /s reports

# Удаление зависимостей (опционально)
pip uninstall psutil pytest pytest-cov pytest-mock -y
```

### Важные замечания

- **Зависимости**: При удалении Python-пакетов убедитесь, что они не используются другими проектами
- **Отчеты**: Рекомендуется сохранить отчеты для анализа эффективности работы системы
- **Конфигурация**: Сохраните `maintenance-config.json` если планируете переустановку

## Отчеты

### Формат отчетов

Отчеты сохраняются в формате JSON в директории, указанной в `reportsPath`.

Имя файла: `report_YYYYMMDD_HHMMSS.json`

### Структура отчета

```json
{
  "reportVersion": "1.0",
  "timestamp": "2025-10-21T20:15:30Z",
  "duration": 2340,
  "hostname": "WORKSTATION-01",
  "summary": {
    "totalSpaceSaved": 68.4,
    "gitReposProcessed": 4,
    "gitReposSuccess": 4,
    "gitReposFailed": 0,
    "workspacesProcessed": 4,
    "workspacesSuccess": 4,
    "workspacesFailed": 0,
    "databasesProcessed": 4,
    "databasesSuccess": 4,
    "databasesFailed": 0
  },
  "gitRepositories": [...],
  "edtWorkspaces": [...],
  "databases": [...],
  "errors": []
}
```

### Просмотр отчетов

Отчеты можно открыть в любом текстовом редакторе с поддержкой JSON:
- Visual Studio Code
- Notepad++
- Браузер с расширением JSONView

## Что делает система

### Git-репозитории

1. **Диагностика garbage**: проверка размера мусорных файлов через `git count-objects -v`
2. **Удаление некомплектных pack-файлов**: pack-файлы без соответствующих .idx индексов
3. **Очистка удаленных веток**: `git remote prune origin`
4. **Сборка мусора**: `git gc --prune=now`

**Результат**: уменьшение размера репозитория на 40-60% (с 25-30 ГБ до 12-15 ГБ)

### EDT Workspaces

Безопасное удаление только временных файлов (white-list):

- **Логи**: `.metadata/.log`, `.metadata/.bak_*.log`, `*.log` в plugins
- **Локальная история**: `.metadata/.plugins/org.eclipse.core.resources/.history/`
- **Снапшоты**: `.snap`, `*/snapshots/`
- **Кэши**: `.bundle_pool/`, `workbench.xmi.bak`, `.safetable/`
- **Индексы**: `*.index` в `org.eclipse.jdt.core/`

**НЕ удаляется**:
- Метаданные проектов (`.projects/`)
- Настройки (`.settings/`, `com.e1c.*/`)
- Конфигурационные файлы

**Результат**: освобождение 60-80% места, быстрая переиндексация (2-5 минут при следующем запуске EDT)

### Базы данных 1С

1. Проверка доступности базы (не открыта в 1С)
2. Запуск `1cv8.exe DESIGNER /F <путь> /TestAndRepair`
3. Дефрагментация и оптимизация базы

**Результат**: освобождение 20-40% места, улучшение производительности

## Безопасность

### Проверки перед обслуживанием

- ✅ Git-репозитории: проверка блокировки файлов
- ✅ EDT workspaces: проверка `.metadata/.lock` и процессов `1cedt.exe`, `eclipse.exe`
- ✅ Базы 1С: проверка эксклюзивного доступа

### Защита данных

- ✅ Использование только безопасных операций
- ✅ Удаление только временных файлов и кэшей
- ✅ Изоляция ошибок: сбой одного объекта не прерывает обработку остальных
- ✅ Детальное логирование всех операций
- ✅ Пароли хранятся в Base64 (минимальная защита)

## Разработка и тестирование

### Запуск тестов

```bash
# Все тесты
pytest tests/

# С покрытием кода
pytest --cov=src tests/

# Конкретный модуль
pytest tests/test_utils.py
```

### Структура проекта

```
1C-Sweeper/
├── src/
│   ├── maintenance.py      # Основной модуль
│   ├── git_handler.py      # Обработчик Git
│   ├── edt_handler.py      # Обработчик EDT
│   ├── db_handler.py       # Обработчик 1С
│   ├── reporter.py         # Генератор отчетов
│   └── utils.py            # Утилиты
├── tests/                  # Тесты
├── docs/                   # Документация
├── install.py              # Установщик
├── uninstall.py            # Деинсталлятор
├── requirements.txt        # Зависимости
└── README.md              # Этот файл
```

## Устранение проблем

### Git не найден

```
[ERROR] Git is not available in the system
```

**Решение**: Убедитесь что Git установлен и доступен из командной строки:
```bash
git --version
```

### Платформа 1С не найдена

```
[ERROR] 1C platform not found (version mask: 8.3.27)
```

**Решение**: 
- Проверьте установку платформы 1С
- Измените маску версии в конфигурации (`platformVersion`)
- Удалите маску версии для использования любой установленной версии

### Workspace заблокирован

```
[ERROR] Workspace is locked (EDT is running)
```

**Решение**: Закройте EDT перед запуском обслуживания

### База данных заблокирована

```
[ERROR] Database is locked (in use)
```

**Решение**: Закройте все сеансы 1С для данной базы

## Рекомендуемое время запуска

Для максимальной эффективности запускайте обслуживание:

- ⏰ Вне рабочего времени (вечер, ночь, выходные)
- 🚫 Когда не ведется активная разработка
- ✅ При отсутствии открытых сеансов 1С и EDT
- 💻 При минимальной нагрузке на систему

**Типичное время выполнения** (последовательный режим):
- Git-репозиторий (25-30 ГБ): ~10 минут
- EDT workspace (5-10 ГБ): 0.5-2 минуты
- База 1С (5 ГБ): 5-15 минут
- **Всего (4+4+4 объекта)**: 65-105 минут

## Лицензия

См. файл [LICENSE](LICENSE)

## Поддержка

По вопросам и проблемам создавайте [Issues](https://github.com/yourusername/1C-Sweeper/issues)

## История изменений

### Версия 1.0.0 (2025-10-21)

- ✅ Обработка Git-репозиториев с очисткой garbage
- ✅ Обработка EDT workspaces с безопасной очисткой
- ✅ Обработка баз 1С с тестированием и исправлением
- ✅ JSON-отчеты с детальной статистикой
- ✅ Интерактивный установщик
- ✅ Интеграция с планировщиком задач Windows
- ✅ Тихий режим для автоматического запуска

