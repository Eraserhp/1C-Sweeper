# План реализации 1C-Sweeper

## Архитектура проекта

```
1C-Sweeper/
├── src/
│   ├── maintenance.py          # Основной исполняемый модуль
│   ├── git_handler.py          # Обработка Git-репозиториев
│   ├── edt_handler.py          # Обработка EDT workspaces
│   ├── db_handler.py           # Обработка баз 1С
│   ├── reporter.py             # Формирование JSON-отчетов
│   └── utils.py                # Утилиты (поиск объектов, проверки)
├── tests/
│   ├── test_utils.py           # Тесты утилит
│   ├── test_git_handler.py     # Тесты Git-обработчика
│   ├── test_edt_handler.py     # Тесты EDT-обработчика
│   ├── test_db_handler.py      # Тесты 1С-обработчика
│   ├── test_reporter.py        # Тесты генерации отчетов
│   ├── test_maintenance.py     # Интеграционные тесты
│   └── fixtures/               # Тестовые данные и моки
│       ├── mock_config.json
│       └── mock_git_repo/
├── docs/
│   └── technical_specification.md  # ТЗ (уже существует)
├── install.py                  # Установщик с интерактивной настройкой
├── maintenance-config.json     # Конфигурационный файл (создается установщиком)
├── requirements.txt            # Python-зависимости
└── README.md                   # Руководство пользователя
```

## Этапы реализации

### 1. Базовая структура проекта

- Создать `requirements.txt` с зависимостями (psutil)
- Создать каркас основных модулей в `src/`
- Реализовать `utils.py` с общими функциями:
  - Поиск объектов по путям
  - Получение размеров файлов/папок
  - Проверка блокировок файлов
  - Поиск платформы 1С по маске версии

### 2. Обработчик Git-репозиториев (`git_handler.py`)

- Проверка наличия Git
- Поиск репозиториев (явные пути + searchPaths)
- Проверка размера относительно порога
- **Диагностика и очистка garbage:**
  - `git count-objects -v` для определения размера garbage
  - Поиск pack-файлов без .idx в `.git/objects/pack/`
  - Безопасное удаление некомплектных pack-файлов
- Выполнение `git remote prune origin`
- Выполнение `git gc --prune=now`
- Логирование размеров до/после, garbage, количества удаленных pack-файлов

### 3. Обработчик EDT workspaces (`edt_handler.py`)

- Поиск workspaces (явные пути + searchPaths по наличию `.metadata`)
- Проверка размера относительно порога
- **Проверка доступности:**
  - Блокировка `.metadata/.lock`
  - Процессы `1cedt.exe`, `eclipse.exe`
- **Безопасная очистка (white-list):**
  - Логи: `.metadata/.log`, `.metadata/.bak_*.log`, `*.log` в plugins
  - История: `.metadata/.plugins/org.eclipse.core.resources/.history/`
  - Снапшоты: `.snap`, `*/snapshots/`
  - Кэши: `.bundle_pool/`, `workbench.xmi.bak`, `.safetable/`
  - Индексы: `*.index` в `org.eclipse.jdt.core/`
- Подсчет удаленных файлов с детализацией по типам
- Логирование размеров до/после

### 4. Обработчик баз 1С (`db_handler.py`)

- Поиск баз (явные пути + searchPaths для файлов `.1CD`)
- Проверка размера относительно порога
- **Поиск платформы 1С:**
  - Автоматический поиск установленных версий в Program Files
  - Фильтрация по маске версии из конфигурации
  - Выбор максимальной подходящей версии
- Проверка занятости базы (попытка эксклюзивного доступа)
- Запуск `1cv8.exe DESIGNER /F <путь> /TestAndRepair`
- Поддержка аутентификации (логин/пароль в Base64)
- Логирование размеров до/после, версии платформы

### 5. Формирование отчетов (`reporter.py`)

- Создание JSON-отчета по структуре из ТЗ (Приложение В):
  - Timestamp, duration, hostname
  - Summary: totalSpaceSaved, количество обработанных объектов
  - Детали по каждому Git-репозиторию (включая garbage-метрики)
  - Детали по каждому EDT workspace (включая категории файлов)
  - Детали по каждой базе 1С
  - Массив ошибок
- Сохранение в `reportsPath` с именем формата `report_YYYYMMDD_HHMMSS.json`

### 6. Основной модуль (`maintenance.py`)

- Загрузка конфигурации из `maintenance-config.json`
- Валидация параметров конфигурации
- Последовательный вызов обработчиков (Git → EDT → 1C)
- Агрегация результатов для отчета
- Обработка ошибок с продолжением работы
- **Режимы работы:**
  - Обычный режим: подробный вывод в консоль с цветами
  - Тихий режим (`-s` или `--silent`): только критические ошибки
- Код возврата: 0 = успех, 1 = ошибки

### 7. Установщик (`install.py`)

- Проверка Python версии (≥3.8)
- Установка зависимостей: `pip install -r requirements.txt`
- **Интерактивный сбор конфигурации:**
  - Пути для поиска Git-репозиториев
  - Пути для поиска EDT workspaces
  - Пути для поиска баз 1С
  - Версия платформы 1С (маска)
  - Учетные данные для баз (опционально)
  - Пороги размеров (с значениями по умолчанию)
  - Путь для отчетов (по умолчанию `./reports`)
- Создание `maintenance-config.json`
- Создание папки для отчетов
- **Настройка планировщика задач Windows:**
  - Создание задачи через `schtasks`
  - Запуск еженедельно в нерабочее время (например, воскресенье 22:00)
  - Тихий режим для автозапуска
- Тестовый запуск для проверки

### 8. Автоматическое тестирование

- Unit-тесты с использованием `pytest`:
  - Парсинг и валидация конфигурации
  - Функции поиска объектов
  - Расчет размеров файлов/папок
  - Поиск платформы 1С по маске
  - Формирование JSON-отчетов
- Mock-объекты для безопасного тестирования:
  - Мок Git-репозиториев (без реального вызова git gc)
  - Мок EDT workspace структуры
  - Мок файловой системы где необходимо
- Интеграционные тесты основного модуля
- Покрытие кода минимум 70%
- Добавить pytest в `requirements.txt` (dev-зависимость)

**Команды:**

- `pytest tests/` - запуск всех тестов
- `pytest --cov=src tests/` - запуск с покрытием кода

### 9. Документация и финализация

- Обновить `README.md`:
  - Описание проекта
  - Требования
  - Установка (запуск `install.py`)
  - Ручной запуск
  - Структура конфигурации
  - Просмотр отчетов
  - Удаление/обновление задачи планировщика
  - Запуск тестов для разработчиков
- Пример конфигурации в README
- Проверка соответствия ТЗ

## Ключевые технические решения

**Обработка Git:**

- Приоритет на очистку garbage pack-файлов (основная причина раздувания)
- Без `--aggressive` для экономии времени
- Детальная метрика garbage в отчете

**Обработка EDT:**

- Жестко закодированный white-list безопасных путей
- Проверка блокировки перед началом работы
- Детализация удаленных файлов по категориям

**Обработка 1С:**

- Автопоиск платформы с поддержкой маски версии
- Проверка занятости базы перед обслуживанием
- Base64 для паролей (минимальная защита)

**Отчеты:**

- Машиночитаемый JSON
- Размеры в ГБ с точностью до сотых
- Полная детализация операций

**Установщик:**

- Интерактивный режим с подсказками
- Автопоиск объектов для удобства
- Интеграция с Windows Task Scheduler

## Статус реализации

### Завершено ✅

- [x] Создать структуру проекта: requirements.txt, src/ с заглушками модулей, базовый utils.py
- [x] Реализовать utils.py: поиск объектов, размеры, проверка блокировок, поиск платформы 1С
- [x] Реализовать git_handler.py: поиск репозиториев, очистка garbage, gc, метрики
- [x] Реализовать edt_handler.py: поиск workspaces, проверка блокировок, безопасная очистка white-list
- [x] Реализовать db_handler.py: поиск баз, поиск платформы 1С, запуск TestAndRepair
- [x] Реализовать reporter.py: формирование JSON-отчетов по структуре из ТЗ
- [x] Реализовать maintenance.py: загрузка конфигурации, вызов обработчиков, консольный вывод, тихий режим
- [x] Реализовать install.py: интерактивный сбор конфигурации, настройка планировщика Windows, тестовый запуск
- [x] Обновить README.md с инструкциями по установке, использованию и примерами конфигурации
- [x] Создать базовые unit-тесты для utils.py

### В процессе 🚧

- [ ] Создать дополнительные тесты для обработчиков
- [ ] Создать интеграционные тесты
- [ ] Создать тестовые fixtures и mock-объекты

### Следующие шаги 📋

1. Завершить тестовое покрытие для всех модулей
2. Провести тестирование на реальной системе
3. Исправить найденные ошибки
4. Оптимизировать производительность
5. Подготовить релиз версии 1.0.0

